@using CORE.Tables
@{
    var boxes = (List<TB_BOXES>)ViewBag.boxes;
    var subjects = (List<TB_SUBJECTS>)ViewBag.subjects;
    var teachers = (List<TB_USERS>)ViewBag.teachers;
    var boxSubject = (List<CORE.Views.V_BOX_SUBJECT>)ViewBag.BoxSubject;
}

<div class="modal-dialog">
    <div class="modal-content">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">&times;</button>
            <h5 class="modal-title">Chi tiết</h5>
        </div>
        <div class="modal-body">
            <!-- Voucher info -->
            <div class="panel panel-flat">
                <div class="panel-body" style="max-height: 600px;overflow-y: auto;">
                    <form action="#">
                        <div class="form-group">
                            <div class="row">
                                <div class="col-md-12">
                                    <input type="hidden" value="" class="form-control" id="ScheduleId">
                                </div>
                            </div>
                        </div>

                        <div class="form-group">

                            <div class="row">
                                <div class="col-md-6">
                                    <label>Khối</label>
                                    <select class="form-control select-search" id="BoxId" onchange="changeBox()">
                                        @foreach (var box in boxes)
                                        {
                                            <option value="@box.BoxId">@box.BoxCode</option>
                                        }
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label>Tên môn học:</label>
                                    <select class="form-control select-search" id="BoxSubjectId" disabled>
                                        @foreach (var subject in boxSubject)
                                        {
                                            <option value="@subject.SubjectId">@subject.SubjectName</option>
                                        }

                                    </select>
                                </div>

                            </div>
                        </div>

                        <div class="form-group">
                            <div class="row">
                                <div class="col-md-4">
                                    <label>Giờ vào</label>
                                    <div class="input-group">
                                        <div class="input-group">
                                            <span class="input-group-addon"><i class="icon-alarm"></i></span>
                                            <div class="input-group">
                                                <input type="text" onchange="CheckValue()" class="form-control pickatime" id="TimeStart">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label>Giờ kết thúc</label>
                                    <div class="input-group">
                                        <span class="input-group-addon"><i class="icon-alarm"></i></span>
                                        <div class="input-group">
                                            <input type="text" onchange="CheckValue()" class="form-control pickatime" id="TimeEnd">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="row">
                                <div class="col-md-4">
                                    <label>Giờ vào</label>
                                    <div class="input-group">
                                        <div class="input-group">
                                            <span class="input-group-addon"><i class="icon-alarm"></i></span>
                                            <input type="text" placeholder="dd/mm/yyyy" class="form-control pickadate" id="DateStart">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label>Giờ kết thúc</label>
                                    <div class="input-group">
                                        <span class="input-group-addon"><i class="icon-alarm"></i></span>
                                        <input type="text" placeholder="dd/mm/yyyy" id="DateEnd" class="form-control pickadate ">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">

                            <div class="row">
                                <div class="col-md-6">
                                    <label>Giá</label>
                                    <input type="text" class="form-control not-empty" id="Price" onchange="checkNumber">
                                </div>
                                <div class="col-md-6">
                                    <label>Ngày học</label>
                                    <select class="form-control select-search" onchange="CheckValue()" id="dayOfWeek">
                                        <option value="">Chọn ngày học</option>
                                        <option value="THU2">Thứ 2</option>
                                        <option value="THU3">Thứ 3</option>
                                        <option value="THU4">Thứ 4</option>
                                        <option value="THU5">Thứ 5</option>
                                        <option value="THU6">Thứ 6</option>
                                        <option value="THU7">Thứ 7 </option>
                                        <option value="CN">Chủ nhật</option>

                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">

                            <div class="row">
                                <div class="col-md-6">
                                    <label>Trạng thái:</label>
                                    <select class="form-control select-search" id="Status">
                                        <option value="A" selected="selected">Kích hoạt</option>
                                        <option value="D" selected="selected">Không kích hoạt</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label>Giáo viên chính</label>
                                    <select class="form-control select-search txtboxes text-center no-padding" id="UserId" disabled>
                                        <option value="">-- Chọn giáo viên --</option>
                                        @for (int i = 0; i < teachers.Count; i++)
                                            {
                                                <option value="@teachers[i].UserId">@teachers[i].UserFullName</option>
                                            }
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="row">
                                <div class="col-md-12">
                                    <label>Mô tả</label>
                                    <textarea rows="8" id="UserNote" class="form-control"></textarea>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <!-- /Voucher info -->
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-link" data-dismiss="modal">Đóng</button>
            <button type="button" class="btn btn-primary btnSave">Lưu</button>
        </div>
    </div>
</div>

<script>
    let boxSubject = @Html.Raw(Json.Encode(boxSubject));
    function changeBox(){
        $('#BoxSubjectId').html('');
        var boxId = $('#BoxId').val();
        var arr = boxSubject.filter(x=>x.BoxId == boxId);
        var html = "";
        for(var i =0;i<arr.length;i++){
            html+= "<option value = "+arr[i].BoxSubjectId+">" + arr[i].SubjectName+"</option>";
        }
        $('#BoxSubjectId').html(html);
        $('#BoxSubjectId').removeAttr("disabled","false");
    }

    function CheckValue(){
        CheckValidateTeacher();
    }
    function CheckValidateTeacher(){
        if($('#UserId').val() != null){
            //if($('#UserId').val().length ==0){
                var timeFrom = ConvertTime($('#TimeStart').val());
                var timeTo = ConvertTime($('#TimeEnd').val());
                var dayOfWeek = $('#dayOfWeek').val();
                if(timeFrom.length >0 &&  timeTo.length >0 && dayOfWeek.length >0){
                    GetTeacher(dayOfWeek , timeFrom, timeTo);
                }

            //}
        }
       
    }
    function ConvertTime(time){
        var result="";
        var am = time.indexOf("AM");
        var pm = time.indexOf("PM");
        if(am != -1){
            var time = time.split('AM')[0].trim();
            result = time + ":00";
        }else if(pm != -1){
            var time = time.split('PM')[0].trim();
            var arr = time.split(':');
            result = (parseInt(arr[0])+12) + ":"+arr[1]+":"+"00";
        }
        return result;
    }
    function GetTeacher(dayOfweek , timeFrom, timeTo){
      
        var params = {
            dayOfWeek: dayOfweek,
            timeFrom: timeFrom,
            timeTo: timeTo
        };
        console.log(params);
        $.ajax({
            url: "/Admin/Ajax/GetTeacherByDateWeekTime",
            type: "Post",
            data:params,
        }).done(function (result) {
            console.log(result);
            if (result.Data.Code == "0") {
                $('#UserId').html('');
                var arr = result.Data.Result;
                var html = "";
                for(var i =0;i<arr.length;i++){

                    html+= "<option value = "+arr[i].UserId+">" + arr[i].UserFullName+"</option>";
                }
                $('#UserId').html(html);
                $('#UserId').removeAttr("disabled","false");
            } 
        });


    }
    features.insertOrUpdate("/Admin/Ajax/InsertOrUpdateClass", getSubParam, getParamsForSearch);

</script>