@using AFD.Tables
@{
    ViewBag.Title = "GroupListDetail";
    Layout = "~/Views/Shared/_HomeLayout.cshtml";
    List<SYS_BOXES> listBox = ViewBag.listBoxes;
    int? height = (int?)ViewBag.height;
}

@helper GenBoxCombo(List<SYS_BOXES> list, string parent, string sf, int sp)
{
foreach (SYS_BOXES item in list.Where(x => (!string.IsNullOrEmpty(parent) && !string.IsNullOrEmpty(x.BOX_PARENT_ID) && x.BOX_PARENT_ID == parent)
    || (string.IsNullOrEmpty(parent) && string.IsNullOrEmpty(x.BOX_PARENT_ID))))
{
        <option value="@item.BOX_ID">@(sf + sp + "." + item.BOX_NAME)</option>
    if (list.Any(x => !string.IsNullOrEmpty(x.BOX_PARENT_ID) && x.BOX_PARENT_ID == item.BOX_ID))
    {
            @GenBoxCombo(list, item.BOX_ID, sf + sp + ".", 1);
    }
    sp = sp + 1;
}
}

<div class="page-header page-header-default">
    <div class="page-header-content" style="background-color: #fcfcfc;">
        <div class="page-title" style="padding: 20px 0;">
            <h4>
                <a href="javascript:void(0);" onclick="history.go(-1);"><i class="icon-arrow-left52 position-left"></i></a>
                <span class="text-semibold">Hệ thống</span> - Chi tiết Group
            </h4>
        </div>
    </div>
</div>
<div class="div-h100 div-top69">
    <div class="panel-body div-h100-body" style="overflow: auto;">
        <div class="row">
            <div class="col-sm-6">
                <div class="well">
                    <div class="form-group">
                        <label>Tên nhóm</label>
                        <input type="text" id="GROUP_NAME" value='@ViewBag.group.GROUP_NAME' class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Mô tả</label>
                        <textarea cols="30" rows="6" id="GROUP_DESCRIPTION" class="form-control" style="resize: vertical;">@ViewBag.group.GROUP_DESCRIPTION</textarea>
                    </div>
                    <div class="form-group">
                        <label>Trạng thái</label><br>
                        <div class="checkbox checkbox-switchery">
                            <label>
                                <input type="checkbox" class="switchery" id="GROUP_ACTIVE" @(ViewBag.group.GROUP_ACTIVE ? "checked" : "")>
                                <span>Kích hoạt</span>
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Chi nhánh</label><br>
                        <select class="form-control" id="boxes">
                            @GenBoxCombo(listBox, (string)ViewBag.BoxRootID, "", 1)
                        </select>
                    </div>
                </div>
                <div class="text-right div-p-20-0">
                    <button type="button" class="btn btn-primary btnUpdate" data-action="CAPNHAT">Cập nhật thông tin group</button>
                </div>
            </div>
            <div class="col-sm-6">
                <div class="well">
                    @{ Html.RenderAction("_GroupRoleDetail", new { groupid = ViewBag.groupId }); }
                </div>
                <div class="text-right div-p-20-0">
                    <button type="button" class="btn btn-primary btnUpdate" data-action="THEMROLE">Cập nhật Role</button>
                </div>
            </div>
        </div>
        <div style="clear: both;"></div>
        <div class="row">
            <div class="col-sm-6 form-group table-responsive">
                <div class="well">
                    <label for="">Danh sách user trong nhóm</label>
                    <div class="inGroupWrapper">
                        @if (@ViewBag.groupId != "")
                        {
                            Html.RenderAction("_GroupListDetail", new { isGroup = "I" });
                        }
                    </div>
                </div>
            </div>
            <div class="col-sm-6">
                <div class="well">
                    <label for="">Danh sách user không trong nhóm</label>
                    <div class="outGroupWrapper">
                        @{ Html.RenderAction("_GroupListDetail", new { isGroup = "O" }); }
                    </div>
                </div>
            </div>
            <div class="col-sm-12">
                <div class="text-right div-p-20-0">
                    <button type="button" class="btn btn-primary btnUpdate" data-action="THEMUSER">Thêm User</button>
                    <button type="button" class="btn btn-primary btnUpdate" data-action="XOAUSER">Xóa User</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        $("#boxes").val('@ViewBag.group.GROUP_BOXID');
    })

    $(".btnUpdate").click(function () {
        let dataGroup = {
            GROUP_ID: '@ViewBag.group.GROUP_ID',
            GROUP_NAME: $("#GROUP_NAME").val(),
            GROUP_ACTIVE: $("#GROUP_ACTIVE").prop("checked"),
            GROUP_DESCRIPTION: $("#GROUP_DESCRIPTION").val(),
            GROUP_CREATEBY: '@ViewBag.group.GROUP_CREATEBY',
            GROUP_CREATETIME: '@ViewBag.group.GROUP_CREATETIME',
            GROUP_BOXID: $("#boxes").val()
        }
        if (dataGroup.GROUP_NAME == '') {
            toastr.error('Trường này  không được trống');
            $("#GROUP_NAME")[0].focus();
            return;
        }
        let listUserId = [];
        let action = $(this).data("action");

        if (action == "XOAUSER") {
            $('.inGroup:checkbox').each(function () {
                if ($(this).prop('checked')) {
                    listUserId.push($(this).data("id"));
                }
            });
            if (listUserId.length == 0) {
                toastr.error("Vui lòng chọn một user");
                return;
            }
        } else if (action == "THEMUSER") {
            $('.outGroup:checkbox').each(function () {
                if ($(this).prop('checked')) {
                    listUserId.push($(this).data("id"));
                }
            });
            if (listUserId.length == 0) {
                toastr.error("Vui lòng thêm User trong nhóm");
                return;
            }
        }

        let listRoleId = [];
        if (action == "THEMROLE") {
            let dataTreeNode = $(".tree-checkbox-hierarchical").fancytree("getTree").getSelectedNodes();
            for (let i = 0; i < dataTreeNode.length; i++) {
                if (dataTreeNode[i].data.id != undefined) {
                    listRoleId.push(dataTreeNode[i].data.id.toString());
                }
            }
            if (listRoleId.length === 0) {
                toastr.error('Vui lòng chọn một Role');
                return;
            }
        }
        

        $.ajax({
            url: "/Ajax/AddOrUpdateGroup",
            type: "post",
            data: {
                group: dataGroup,
                createBy: '@ViewBag.User',
                listUserId: listUserId,
                listRoleId: listRoleId,
                action: action
            },
        }).done(function (result) {
            alertResult(result);
        });
    })
    let getParamsForSearch = (pageNumber, isNext) => {
        return {
            "pageNumber": pageNumber + isNext,
            "pageSize": 10,
        };
    }

    function alertResult(result) {
        if (result) {
            toastr.success("Thành công")
            setTimeout(function () {
                location.reload();
            }, 1500);
        } else {
            toastr.error("Da xay ra loi !!!")
        }
    }
</script>